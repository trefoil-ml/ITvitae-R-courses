/*! revo-dtree 2016-06-03 */
!function(a,b,c){"undefined"!=typeof module&&module.exports?module.exports=c():"function"==typeof define&&define.amd?define(c):b[a]=c()}("dtree",this,function(){function a(b){this.options=b,a.palette=b.palette||a.palette,this.render();var c=q.select("#legend-toggle");c.on("click",function(a){var b="-"===c.html();c.html(b?"+":"-");var d=q.select("#dep-legend");d.style("display",b?"none":"block")})}function b(b){function d(a){a&&a.children&&(a.children.forEach(d),e(a))}r=q.select("#"+b.id),t=q.scale.linear(),u=q.scale.linear(),v=q.layout.tree().size([C,B]),w=q.svg.diagonal().projection(function(a){return[a.x,a.y]}),x=r.append("svg:svg").attr("id","_tree").attr("width",B+A[1]+A[3]).attr("height",C+A[0]+A[2]+1e3).append("svg:g").attr("transform","translate(0,"+A[0]+")"),y=q.scale.linear(),z=q.scale.category10(),s=b.data,s.x0=0,s.y0=0,G=j(s),y=q.scale.linear().domain([s.summary.minn,s.n]).range([K,J]);var f=b.palette?b.palette.range:a.palette.range;if("class"===s.method){var g=s.legend.depVars.levels.length-1;u=q.scale.linear().domain([s.summary.minloss,s.summary.maxloss]).range([L,M]),t=q.scale.linear().domain([0,g]).range(f)}else u=q.scale.linear().domain([s.summary.mindev,s.summary.maxdev]).range([L,M]),t=q.scale.linear().domain([s.legend.depVars.minyval,s.legend.depVars.maxyval]).range(f);E=new a({palette:b.palette,method:s.method,rule:{depVars:s.legend.depVars,indVars:s.legend.indVars}}).channels(),s.children.forEach(d),c(s)}function c(a){d(a);var b=500,j=v.nodes(s).reverse();j.forEach(function(a){a.y=90*a.depth});var m=x.selectAll("g.node").data(j,function(a){return a.id||(a.id=++D)}),n=m.enter().append("svg:g").attr("class","node").attr("transform",function(b){return"translate("+a.x0+","+a.y0+")"}).on("click",function(a){"leaf"!==a.type&&(F=!0,setTimeout(function(){F=!1,d(a)},580),q.event&&q.event.altKey?(k(a),l(a)):q.event&&(q.event.ctrlKey||q.event.metaKey)?(k(a),e(a)):e(a),c(a))}).call(q.helper.tooltip(s.method).text(function(a){return a}));n.append("svg:rect").attr("class","tree-node").attr("y",-1).attr("x",function(a){var b=q.max([H,H]);return-b/2}).attr("width",1e-6).attr("height",1e-6).attr("rx",function(a){return"split"===a.type?20:2}).attr("ry",function(a){return"split"===a.type?20:2}).style("stroke",function(a){return"#5b5b5b"}).style("stroke-width",g).style("fill",f),n.append("svg:text").attr("fill","#333333").attr("class","tree-label"+(N.labels?"":" hide")).attr("dy",21).attr("text-anchor","middle").attr("text-orig",h).text(function(a){return i(h(a),N.labelLength)}).style("fill-opacity",1e-6);var o=m.transition().duration(b).attr("transform",function(a){return"translate("+a.x+","+a.y+")"});o.select("rect").attr("width",function(a){var b=q.max([H,H]);return b}).attr("height",I).style("stroke-width",g).style("fill",f),o.select("text").style("fill-opacity",1);var p=m.exit().transition().duration(b).attr("transform",function(b){return"translate("+a.x+","+a.y+")"}).remove();p.select("rect").attr("width",1e-6).attr("height",1e-6),p.select("text").style("fill-opacity",1e-6);var r=x.selectAll("path.link").data(v.links(j),function(a){return a.target.id});r.enter().insert("svg:path","g").attr("class","link").attr("node-id",function(a){return a.target.id}).attr("d",function(b){var c={x:a.x0,y:a.y0};return w({source:c,target:c})}).transition().duration(b).attr("d",w).style("stroke-width",function(a){return y(a.target.n)}).style("stroke",G),r.transition().duration(b).attr("d",w).style("stroke-width",function(a){return y(a.target.n)}).style("stroke",G),r.exit().transition().duration(b).attr("d",function(b){var c={x:a.x,y:a.y};return w({source:c,target:c})}).remove(),j.forEach(function(a){a.x0=a.x,a.y0=a.y})}function d(a){q.select("#tree").selectAll(".link").style("stroke","lightgray"),q.select("#path").html(function(){return window.tmpl("pred-path",{variable:s.legend.depVars.name})});var b=q.select("#pred-path-list");b.html("");var c=[];c.push({pred:a.yval,label:a.label,shape:"leaf"===a.type?"square":"circle",color:f(a)});for(var d=[a.id],e=v.nodes([a])[0][0];;){var g=e.parent;if(!g)break;d.push(g.id),e=g,c.push({label:e.label,shape:"leaf"===e.type?"square":"circle",color:f(e)})}c=c.reverse(),c.forEach(function(a,d){a.label=c[d+1]?c[d+1].label:"Prediction: "+a.pred,TPL='<div class="shape '+a.shape+'" style="background-color:'+a.color+'"><div class="split-info">'+a.label+"</div></div>",b.append("li").html(TPL)});var h=q.select("#tree").selectAll(".link")[0];h.forEach(function(a){for(var b=parseInt(a.getAttribute("node-id"),10),c=0;c<d.length;c++)if(d[c]===b){q.select(a).style("stroke","#333");break}})}function e(a){a.children?(a._children=a.children,a.children=null):(a.children=a._children,a._children=null)}function f(a){var b=a.yval;return"class"===s.method&&"leaf"===a.type&&(b=0,s.legend.depVars.levels.forEach(function(c,d){c===a.yval&&(b=d)})),N.colors?"leaf"===a.type?t(b):E[a.splitVar]:"#ffffff"}function g(a){var b="class"===s.method?a.loss:a.deviance;return N.borders?u(b):1}function h(a){var b="leaf"===a.type?a.yval:"multiple"===a.splitVal?"":a.splitVal;return""===b||isNaN(b)?b:q.round(b,2)}function i(a,b){return b=b||"*",a+="",isNaN(b)||b>=a.length?a:a.substring(0,b)}function j(a){function b(a){return"lightgray"}return b}function k(a){function b(a){a&&a.children&&(a.children.forEach(b),e(a))}b(a)}function l(a){function b(a){a&&a._children&&(a._children.forEach(b),e(a))}b(a)}function m(a,b){this.o=a,this.fn=b,this.layers={},n.apply(this,arguments)}function n(a,c){if(document.all&&!document.addEventListener)throw{name:"Browser not supported",message:"RevoTreeView is only compatible with Internet Explorer 9 and above. If you are using Internet Explorer 9 then you must be in Standards Mode. We recommend you use Google Chrome for the best User Experience.",toString:function(){return this.name+": "+this.message}};var d=this;$("#layers-dropdown input").each(function(){var a=$(this);a.prop("checked",!0).prop("disabled",!1),a.val(""),d.layers[a.data("layer")]={node:a,id:a.data("layer")}}),b(a),this.bindUI()}function o(a,b){return new m(a,b)}var p=window,q=(document,p.d3||{});!function(){var a={};window.tmpl=function b(c,d){c=a[c]=a[c]||document.getElementById(c).innerHTML;var e=/\W/.test(c)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+c.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):a[c]=a[c]||b(document.getElementById(c).innerHTML);return d?e(d):e}}(),q.helper={},q.helper.tooltip=function(a){function b(){var a=630,b=460;document.body&&document.body.offsetWidth&&(a=document.body.offsetWidth,b=document.body.offsetHeight),"CSS1Compat"==document.compatMode&&document.documentElement&&document.documentElement.offsetWidth&&(a=document.documentElement.offsetWidth,b=document.documentElement.offsetHeight),window.innerWidth&&window.innerHeight&&(a=window.innerWidth,b=window.innerHeight);var c=15;return{w:a-c,h:b}}function c(c){c.on("mouseover.tooltip",function(c,g){if(!F){d(c);q.select("body").selectAll("div.tooltip").remove(),e=q.select("body").append("div"),e.attr(f),e.style(h);var i=c.method,j=200,k=j+25,l=c.x,m="sw",n="s";c.x+k>b().w&&(l=c.x-j,m="se"),i&&(m="nw",top=c.y+105,n="n"),e.style({left:l+"px",top:top,position:"absolute","z-index":1001}),e.html(function(b,d){var e=window.tmpl("class"===a?"classification-tip":"regression-tip",{pD:{pos:m,arrow:n,label:c.label,n:c.n,deviance:c.deviance,loss:c.loss,yval:c.yval,type:c.type,splitVar:c.splitVar}});return e})}}).on("mousemove.tooltip",function(c,d){if(!F&&e){var f=c.method,g=200,h=g+25,i=c.x,j=c.y-50,k="sw",l="s";if(c.x+h>b().w&&(i=c.x-g,k="se"),f&&(k="nw",j=c.y+105,l="n"),e.style({left:i+"px",top:j+"px",position:"absolute","z-index":1001}),e.html(function(b,d){var e=window.tmpl("class"===a?"classification-tip":"regression-tip",{pD:{pos:k,arrow:l,label:c.label,n:c.n,deviance:c.deviance,loss:c.loss,yval:c.yval,type:c.type,splitVar:c.splitVar}});return e}),"class"===a){var m=190,n=33,o=1,p=c.prob,r=q.scale.linear().domain([0,q.max(p)]).range([0,n]),s=q.select("#surface").append("svg").attr("width",m).attr("height",n);s.selectAll("rect").data(p).enter().append("rect").attr("fill",function(a,b){return t(b)}).attr("x",function(a,b){return b*(m/p.length)}).attr("y",function(a){return n-r(a)}).attr("width",function(){return m/p.length-o}).attr("height",r)}}}).on("mouseout.tooltip",function(a,b){e&&e.remove()})}var e,f=(q.select("body").node(),{}),g="",h={};return c.attr=function(a){return arguments.length?(f=a,this):f},c.style=function(a){return arguments.length?(h=a,this):h},c.text=function(a){return arguments.length?(g=q.functor(a),this):g},c},a.palette={range:["#F7F0F9","#BB80C1"],colors:["#8ED3C6","#FFFFA8","#BDBBDD","#FB816E","#80B0D7","#FDB550","#B4DE51","#F8CCE7","#D9D9D9","#CBEAC0","#FFEE53"]},a.prototype.channels=function(){var b={},c=0;return this.options.rule.indVars.forEach(function(d){c=c>a.palette.colors.length-1?0:c,b[d]=a.palette.colors[c],c++}),b},a.prototype.render=function(a){if(this.variables(),"class"===this.options.method){var b=q.select("#dep-legend ul"),c=this.options.rule.depVars.levels;c.forEach(function(a,c){var d=t(c);b.append("li").html(function(b){return'<div class="shape square" style="background-color:'+d+'"><div class="split-info">'+a+"</div></div>"})})}else this.gradient()},a.prototype.variables=function(){var b=this.options,c=this.channels(),d=this.options.method;q.select("#legend").html(function(){return window.tmpl("class"===d?"classification-legend":"regression-legend",{legend:b,range:a.palette.range})});var e=q.select("#legend-vars");for(var f in c){var g=c[f];e.append("li").html(function(a){return'<div class="shape circle" style="background-color:'+g+'"><div class="split-info">'+f+"</div></div>"})}},a.prototype.gradient=function(){function b(b,c){var f=c,g=2*Math.PI/d,h=g*f+g/2,i=h+Math.PI,j=50*Math.cos(h)+50,k=50*Math.cos(i)+50,l=50*Math.sin(h)+50,m=50*Math.sin(i)+50,n=e.append("svg:linearGradient").attr("id",b+f).attr("x1",j+"%").attr("y1",l+"%").attr("x2",k+"%").attr("y2",m+"%");return n.append("svg:stop").attr("offset","0%").attr("stop-color",a.palette.range[1]).attr("stop-opacity",.9),n.append("svg:stop").attr("offset","100%").attr("stop-color",a.palette.range[0]).attr("stop-opacity",.9),n}var c=q.select("#gradient").append("svg:svg");c.attr("width","180"),c.append("rect");var d=360,e=(q.range(d),c.append("defs"));q.range(d).forEach(function(a,c){b("grad",c)}),c.append("rect").attr("width","158").attr("height","25").attr("fill","url(#grad0)")};var r,s,t,u,v,w,x,y,z,A=[20,120,20,120],B=1880-A[1]-A[3],C=1580-A[0]-A[2],D=0,E={},F=!1,G="lightgray",H=35,I=35,J=20,K=1.5,L=1,M=15,N={labels:!0,borders:!1,legend:!0,colors:!0,path:!1,labelLength:"",area:!0},O=function(a){a=a||$("#_tree"),parentEl=a.parent(),width=parentEl.width()-(q.select("#legend-container").classed("hide")?0:200),a.attr("width",width),a.attr("height",$(window).height()),v.size([width,width]),this.resizeTO&&clearTimeout(this.resizeTO),this.resizeTO=setTimeout(function(){c(s)},500)};return m.prototype={bindUI:function(){var a=this,b=this.layers;b.border.node.prop("checked",!1),b.legcolor.node.prop("checked",!0),$("#layers-dropdown").on("click",function(b){switch(b.stopPropagation(),$(b.target).data("layer")){case"label":a.toggleLabels();break;case"border":a.toggleBorders();break;case"color":a.toggleColor();break;case"legcolor":N.legend||a.toggleLegendMode("legend","path");break;case"path":N.path||a.toggleLegendMode("path","legend");break;case"legend":a.toggleLegendArea()}}),b.truncate.node.on("keyup",function(b){N.labelLength=parseInt(this.value,10),this.upInterval&&clearTimeout(this.upInterval),this.upInterval=setTimeout(function(){a.truncateLabel()},500)});var c=$("#_tree");$(window).on("resize",function(){O(c)}).trigger("resize")},truncateLabel:function(){var a=N.labelLength;r.selectAll(".tree-label")[0].forEach(function(b,c){b.textContent=b.innerHTML=i(b.getAttribute("text-orig"),a)})},toggleLabels:function(){N.labels=!N.labels,r.selectAll(".tree-label").classed("hide",!N.labels)},toggleBorders:function(){N.borders=!N.borders,r.selectAll(".tree-node").style("stroke-width",function(a){return g(a)})},toggleColor:function(){var a=this,b=this.layers;N.colors=!N.colors,d(s),r.selectAll(".tree-node").style("fill",function(c){var d=b.legcolor.node;return d.prop("disabled",!N.colors),d.prop("checked")&&!N.colors?(b.path.node.prop("checked",!0),a.toggleLegendMode("path","legend")):d.prop("checked")&&N.colors&&q.select("#legend").classed("hide",!1),f(c)})},toggleLegendMode:function(a,b){N[a]=!N[a],N[b]=!N[a],q.select("#legend").classed("hide",!N.legend),q.select("#path").classed("hide",!N.path)},toggleLegendArea:function(){var a=this.layers;a.legcolor.node.prop("disabled",N.area),a.path.node.prop("disabled",N.area),N.colors||a.legcolor.node.prop("disabled",!0),q.select("#legend-container").classed("hide",N.area),N.area=!N.area,O()},destroy:function(){}},o});